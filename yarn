# Custom `yarn` command
# to handle copying `.env` file
# based on $DEPLOYMENT value

# Example:
# DEPLOYMENT=staging ./yarn deploy

# Exit immediately if any command exits with a nonzero exit value
# See https://stackoverflow.com/a/821419/359104
set -e

# Parameters
BASE_PATH=$(dirname "$0");
ARGUMENTS="$@"
DEPLOYMENT=$DEPLOYMENT

ENV_FILE=".env.$DEPLOYMENT"
SOURCE_ENV_PATH="$BASE_PATH/secrets/$ENV_FILE"
TARGET_ENV_PATH="$BASE_PATH/.env"
BACKUP_ENV_PATH="$BASE_PATH/.env.backup"

SERVICE_ACCOUNT_KEY_FILE="$DEPLOYMENT.json"
SOURCE_SERVICE_ACCOUNT_KEY_PATH="$BASE_PATH/secrets/serviceAccountKeys/$SERVICE_ACCOUNT_KEY_FILE"
TARGET_SERVICE_ACCOUNT_KEY_PATH="$BASE_PATH/backend/shared/serviceAccountKey.json"
BACKUP_SERVICE_ACCOUNT_KEY_PATH="$BASE_PATH/backend/shared/serviceAccountKey.json.backup"

# Backup existing env file
if [ -f "$TARGET_ENV_PATH" ]
then
  mv -v "$TARGET_ENV_PATH" "$BACKUP_ENV_PATH"
fi

# Copy source env file
cp -v "$SOURCE_ENV_PATH" "$TARGET_ENV_PATH"

# Backup existing serviceAccountKey file
if [ -f "$TARGET_SERVICE_ACCOUNT_KEY_PATH" ]
then
  mv -v "$TARGET_SERVICE_ACCOUNT_KEY_PATH" "$BACKUP_SERVICE_ACCOUNT_KEY_PATH"
fi

# Copy serviceAccountKey file
cp -v "$SOURCE_SERVICE_ACCOUNT_KEY_PATH" "$TARGET_SERVICE_ACCOUNT_KEY_PATH"

# Run command
yarn $ARGUMENTS -P $DEPLOYMENT

# Delete env file
rm "$TARGET_ENV_PATH"

# Restore existing env file
if [ -f "$BACKUP_ENV_PATH" ]
then
  mv -v "$BACKUP_ENV_PATH" "$TARGET_ENV_PATH"
fi

# Restore existing serviceAccountKey file
if [ -f "$BACKUP_SERVICE_ACCOUNT_KEY_PATH" ]
then
  mv -v "$BACKUP_SERVICE_ACCOUNT_KEY_PATH" "$TARGET_SERVICE_ACCOUNT_KEY_PATH"
fi
